<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VoidOS ‚Äî Self-contained Launcher</title>
<link rel="icon" href="https://ssl.gstatic.com/classroom/favicon.png">
<style>
:root{
  --bg:#0c0f14; --panel:#0f1620; --muted:#cbd5e1; --accent:#4f46e5;
  --glass: rgba(255,255,255,0.03);
  --card-radius:12px;
}
*{box-sizing:border-box;font-family:Inter,Segoe UI,Arial,sans-serif}
html,body{height:100%;margin:0;background:var(--bg);color:var(--muted);-webkit-font-smoothing:antialiased}
a{color:inherit}
.hidden{display:none}
#boot{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#000;z-index:9999}
#boot .logo{font-size:48px;font-weight:800;color:var(--accent);letter-spacing:1px;opacity:0;animation:logoIn .9s ease forwards}
#boot .sub{color:#9aa4b2;margin-top:10px;opacity:0;animation:subIn .9s ease .25s forwards}
@keyframes logoIn{0{opacity:0;transform:scale(.85)}100{opacity:1;transform:scale(1)}}
@keyframes subIn{0{opacity:0;transform:translateY(6px)}100{opacity:1;transform:none}}

#status{height:44px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);display:flex;align-items:center;justify-content:space-between;padding:0 14px;border-bottom:1px solid rgba(255,255,255,0.02)}
.status-left{display:flex;align-items:center;gap:12px}
.logoSmall{width:34px;height:34;border-radius:8px;background:linear-gradient(135deg,var(--accent),#9f7aea);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.status-right{display:flex;gap:12px;align-items:center;color:var(--muted)}
#countdown{font-weight:600;color:#fff;background:rgba(0,0,0,0.15);padding:6px 10px;border-radius:8px;font-size:13px}

#main{display:flex;height:calc(100vh - 44px);gap:18px;padding:18px;box-sizing:border-box}
#dock{width:240px;background:var(--panel);border-radius:var(--card-radius);padding:14px;border:1px solid rgba(255,255,255,0.02);overflow:auto}
#desktop{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:var(--card-radius);padding:20px;position:relative;overflow:auto}

h1{margin:0;color:var(--muted)}
.muted{color:#9aa4b2;font-size:13px}

/* grid style (phone-like) */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:18px;margin-top:20px}
.app{display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer}
.icon{width:72px;height:72px;border-radius:18px;background:var(--glass);display:flex;align-items:center;justify-content:center;font-size:26px;color:var(--muted);transition:transform .12s,box-shadow .12s}
.app:hover .icon{transform:translateY(-6px);box-shadow:0 8px 24px rgba(0,0,0,0.6)}
.appLabel{font-size:13px;text-align:center;color:var(--muted)}

/* windows */
.win{position:absolute;background:var(--panel);border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02);overflow:hidden;display:flex;flex-direction:column}
.win .top{height:40px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.win .title{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:8px}
.dot{width:12px;height:12px;border-radius:999px}
.dot.red{background:#ff6b6b}
.win .body{flex:1;background:#0b0f14;padding:8px;min-height:120px}
iframe.emb{width:100%;height:100%;border:0;background:white}

/* small UI */
.formRow{display:flex;gap:8px;align-items:center;margin:8px 0}
input[type="text"]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);width:100%}
button.btn{padding:8px 10px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent),#9f7aea);color:white;cursor:pointer}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}

/* small responsive */
@media (max-width:900px){#dock{display:none}}
/* school portal styles (initial entry page) */
#portal{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#071426,#001219);z-index:20}
.portalCard{width:760px;background:linear-gradient(180deg,#071b2a,#071b34);border-radius:12px;padding:28px;border:1px solid rgba(255,255,255,0.03)}
.portalHeader{display:flex;align-items:center;gap:12px}
.portalHeader h2{margin:0;color:#fff}
.siteList{margin-top:18px;display:flex;flex-direction:column;gap:12px}
.site{padding:14px;background:#071722;border-radius:10px;border:1px solid rgba(255,255,255,0.02);cursor:pointer}
.site:hover{transform:translateX(6px)}
#loaderScreen{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#000;color:#0f0;font-size:20px;z-index:30}

/* small helper */
.small{font-size:12px;color:#9aa4b2}
</style>
</head>
<body>

<!-- BOOT SCREEN -->
<div id="boot">
  <div class="logo">VoidOS</div>
  <div class="sub">Starting up‚Ä¶</div>
</div>

<!-- STATUS -->
<div id="status" class="hidden">
  <div class="status-left">
    <div class="logoSmall">V</div>
    <div>
      <div style="font-weight:700">VoidOS</div>
      <div class="small muted">Local Launcher</div>
    </div>
  </div>
  <div class="status-right">
    <div id="countdown">loading...</div>
    <div id="clock" class="muted small"></div>
  </div>
</div>

<!-- MAIN -->
<div id="main" class="hidden">
  <aside id="dock">
    <h1>Launcher</h1>
    <div class="muted small">Open mode</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="modeInternal" class="ghost">Internal windows</button>
      <button id="modeTabs" class="ghost">New tabs</button>
    </div>
    <div style="margin-top:14px">
      <div class="muted small">GN-Math mirror (opt)</div>
      <div class="formRow"><input id="gnMirror" type="text" placeholder="https://..."></div>
      <div style="display:flex;gap:8px"><button class="btn" onclick="saveMirrors()">Save</button><button class="ghost" onclick="resetMirrors()">Reset</button></div>
    </div>

    <div style="margin-top:12px">
      <div class="muted small">Data</div>
      <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="exportAll()">Export</button><button class="ghost" onclick="importAll()">Import</button></div>
      <div style="margin-top:8px"><button class="ghost" onclick="clearAll()">Clear All</button></div>
    </div>

    <div style="margin-top:14px">
      <div class="muted small">Proxy quick-open</div>
      <div class="formRow"><input id="proxyInput" placeholder="https://example.com"><button class="ghost" onclick="openProxyFromInput()">Open</button></div>
    </div>

  </aside>

  <section id="desktop">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:20px;font-weight:700">Home</div>
        <div class="muted small">Tap an app to open</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="ghost" onclick="openSettings()">Settings</button>
      </div>
    </div>

    <div class="grid" id="grid">
      <div class="app" onclick="launchApp('gnmath')">
        <div class="icon">‚àë</div>
        <div class="appLabel">GN-Math</div>
      </div>

      <div class="app" onclick="launchApp('itch')">
        <div class="icon">üéÆ</div>
        <div class="appLabel">itch.io</div>
      </div>

      <div class="app" onclick="launchApp('proxy')">
        <div class="icon">üß≠</div>
        <div class="appLabel">Proxy Viewer</div>
      </div>

      <div class="app" onclick="launchApp('polytrack')">
        <div class="icon">üõ∞Ô∏è</div>
        <div class="appLabel">PolyTrack</div>
      </div>

      <div class="app" onclick="launchApp('cookie')">
        <div class="icon">üç™</div>
        <div class="appLabel">Cookie Clicker</div>
      </div>

      <div class="app" onclick="openSavesWindow()">
        <div class="icon">üíæ</div>
        <div class="appLabel">Saves</div>
      </div>

      <div class="app" onclick="openSettings()">
        <div class="icon">‚öôÔ∏è</div>
        <div class="appLabel">Settings</div>
      </div>
    </div>

    <!-- windows container -->
    <div id="wins" style="position:absolute;inset:0;pointer-events:none"></div>
  </section>
</div>

<!-- PORTAL (initial entry that simulates the school page & Classroom click) -->
<div id="portal">
  <div class="portalCard">
    <div class="portalHeader">
      <div class="logoSmall">V</div>
      <h2>School Portal</h2>
    </div>

    <div class="siteList">
      <div class="site" onclick="onClassroomClick()">Google Classroom</div>
      <div class="site">Google Docs</div>
      <div class="site">Google Drive</div>
      <div class="site">Khan Academy</div>
      <div class="site">Quizlet</div>
      <div class="site">Library</div>
    </div>

    <p class="small muted" style="margin-top:12px">Enter password when prompted (password: <code>combustus</code>)</p>
  </div>
</div>

<div id="loaderScreen" class="hidden">Loading VoidOS‚Ä¶</div>

<script>
/* ===========================
   State & Initialization
   =========================== */
const state = {
  openMode: localStorage.getItem('void_openMode') || 'internal', // 'internal' or 'tabs'
  mirrors: { gn: localStorage.getItem('void_mirror_gn') || '' },
  saves: JSON.parse(localStorage.getItem('void_saves')||'{}'),
  notes: localStorage.getItem('void_notes') || ''
};
/* set UI mode buttons */
function setModeButtons(){
  document.getElementById('modeInternal').classList.toggle('btn', state.openMode==='internal');
  document.getElementById('modeTabs').classList.toggle('btn', state.openMode==='tabs');
}
setModeButtons();
document.getElementById('modeInternal').onclick = ()=>{ state.openMode='internal'; localStorage.setItem('void_openMode', state.openMode); setModeButtons(); };
document.getElementById('modeTabs').onclick = ()=>{ state.openMode='tabs'; localStorage.setItem('void_openMode', state.openMode); setModeButtons(); };
/* populate mirror if present */
document.getElementById('gnMirror').value = state.mirrors.gn || '';

/* Boot sequence */
setTimeout(()=>{
  document.getElementById('boot').classList.add('hidden');
  document.getElementById('status').classList.remove('hidden');
  document.getElementById('main').classList.remove('hidden');
}, 1400);

/* ===========================
   Countdown to 2:45 PM LA
   =========================== */
function getLaNow(){
  // get LA time by formatting to LA and parsing
  const laStr = new Date().toLocaleString('en-US', {timeZone:'America/Los_Angeles'});
  return new Date(laStr);
}
function getNextTarget(){
  const laNow = getLaNow();
  let t = new Date(laNow.getFullYear(), laNow.getMonth(), laNow.getDate(), 14,45,0);
  if(laNow.getTime() > t.getTime()) t = new Date(laNow.getFullYear(), laNow.getMonth(), laNow.getDate()+1, 14,45,0);
  return {laNow,t};
}
function updateCountdown(){
  const {laNow,t} = getNextTarget();
  let diff = t.getTime() - laNow.getTime();
  if(diff < 0) diff = 0;
  const hrs = Math.floor(diff/3600000); diff %= 3600000;
  const mins = Math.floor(diff/60000); diff %= 60000;
  const secs = Math.floor(diff/1000);
  document.getElementById('countdown').textContent = `${hrs.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')} (LA 14:45)`;
}
setInterval(updateCountdown,1000);
updateCountdown();

/* clock */
function tick(){ document.getElementById('clock').textContent = new Date().toLocaleTimeString(); }
setInterval(tick,1000); tick();

/* ===========================
   Portal / Password flow
   =========================== */
function onClassroomClick(){
  const pwd = prompt("Enter password:");
  if(pwd !== "combustus"){ alert("Incorrect password."); return; }
  // show loader then hide portal and keep OS (we're self-contained)
  document.getElementById('loaderScreen').classList.remove('hidden');
  setTimeout(()=>{
    document.getElementById('portal').classList.add('hidden');
    document.getElementById('loaderScreen').classList.add('hidden');
    // Reveal main UI (already visible from boot). Scroll to top
    window.scrollTo(0,0);
  },700);
}

/* ===========================
   Window system (draggable internal windows)
   =========================== */
let zIndex = 100;
function makeDraggable(el){
  const header = el.querySelector('.top');
  if(!header) return;
  header.style.cursor='grab';
  header.onmousedown = (e)=>{
    e.preventDefault();
    header.style.cursor='grabbing';
    const rect = el.getBoundingClientRect();
    const startX = e.clientX, startY = e.clientY;
    function move(ev){
      el.style.left = (rect.left + ev.clientX - startX) + 'px';
      el.style.top  = (rect.top  + ev.clientY - startY) + 'px';
    }
    function up(){ document.removeEventListener('mousemove',move); document.removeEventListener('mouseup',up); header.style.cursor='grab'; }
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
  };
  el.onmousedown = ()=>{ el.style.zIndex = ++zIndex; el.style.pointerEvents='auto'; };
}

/* create a window; html OR url */
function createWindow({title='Window', width=900, height=600, left=80, top=80, url=null, html=null}){
  const wins = document.getElementById('wins');
  const div = document.createElement('div');
  div.className = 'win';
  div.style.width = width+'px';
  div.style.height = height+'px';
  div.style.left = left+'px';
  div.style.top = top+'px';
  div.style.zIndex = ++zIndex;
  div.style.pointerEvents='auto';
  div.innerHTML = `
    <div class="top">
      <div class="title">${title}</div>
      <div class="controls"><div class="dot red" title="Close"></div></div>
    </div>
    <div class="body"></div>
  `;
  wins.appendChild(div);
  const closeBtn = div.querySelector('.dot.red'); closeBtn.onclick = ()=> div.remove();
  const body = div.querySelector('.body');
  if(html){
    const blob = new Blob([html], {type:'text/html'});
    const src = URL.createObjectURL(blob);
    const ifr = document.createElement('iframe'); ifr.className='emb'; ifr.src = src;
    body.appendChild(ifr);
  } else if(url){
    const ifr = document.createElement('iframe'); ifr.className='emb'; ifr.src = url;
    body.appendChild(ifr);
    // fallback control (open in new tab)
    const fb = document.createElement('div'); fb.style.position='absolute'; fb.style.right='12px'; fb.style.top='44px';
    fb.innerHTML = `<button class="ghost" onclick="window.open('${url}','_blank')">Open in new tab</button>`;
    div.appendChild(fb);
  } else {
    body.innerHTML = '<div class="muted small">No content</div>';
  }
  makeDraggable(div);
  return div;
}

/* ===========================
   Apps and embed content
   =========================== */

/* PolyTrack and CookieClicker HTMLs (directly embedded from user input) */
const polytrackHtml = `<!DOCTYPE html>
<html>
<head>
    <base href="https://cdn.jsdelivr.net/gh/genizy/polytrack@main/">
    <script>
        window.jkdfgnjkndfg = document.querySelector('base').href;
        fetch("simulation_worker.bundle.js").then(res => res.text()).then(text => {
            const blob = new Blob([text.replaceAll("replacethisplease", window.jkdfgnjkndfg)], {
                type: 'application/javascript'
            });
            window.simulationworker = URL.createObjectURL(blob);
        });
        const ogworker = window.Worker;
        window.Worker = function (scriptUrl, options) {
            if (typeof scriptUrl === 'string' && scriptUrl.toLowerCase() === "simulation_worker.bundle.js") {
                const wrapper = {};
                const promise = window.simulationWorkerReady.then(() => {
                    const actualWorker = new ogworker(window.simulationworker, options);
                    Object.assign(wrapper, actualWorker);
                    if (typeof wrapper.onmessage === 'function') {
                        actualWorker.onmessage = wrapper.onmessage;
                    }
                    return actualWorker;
                });
                return new Proxy(wrapper, {
                    get(target, prop) {
                        return (...args) => {
                            promise.then(realWorker => realWorker[prop](...args));
                        };
                    },
                    set(target, prop, value) {
                        promise.then(realWorker => {
                            realWorker[prop] = value;
                        });
                        return true;
                    }
                });
            }
            return new ogworker(scriptUrl, options);
        };
        window.Worker.prototype = ogworker.prototype;
        const ogfetch = window.fetch;
        window.fetch = async function (input, init) {
            if (typeof input === "string") {
                input = input.replace("vps.kodub.com:43273", "vpskodub.tmena1565.workers.dev");
            } else if (input instanceof Request) {
                const newUrl = input.url.replace("vps.kodub.com:43273", "vpskodub.tmena1565.workers.dev");
                input = new Request(newUrl, input);
            }
            return ogfetch(input, init);
        };
        const ogxml = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function (method, url, ...rest) {
            if (typeof url === "string") {
                url = url.replace("vps.kodub.com:43273", "vpskodub.tmena1565.workers.dev");
            }
            return ogxml.call(this, method, url, ...rest);
        };
    </script>
    <link rel="manifest" href="manifest.json" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
</head>
<body>
    <canvas id="screen"></canvas>
    <div id="ui"></div>
    <div id="transition-layer"></div>
    <script type="module" src="main.bundle.js" defer></script>
</body>
</html>`;

const cookieClickerHtml = `<!doctype html>
<html>
<head>
    <meta name="viewport" content="width=900, initial-scale=1">
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-WX5VS54ZDW');
    </script>
    <script src="https://cdn.jsdelivr.net/gh/bcat1023/webprx@8b966f57aeceb9616de5f15455d811ab76df9c8f/gfiles/cookies/old/base64.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/bobydob/JSEngine@135436abead1c966dde378e7e41fe832330b1f5a/dist/main.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/bcat1023/webprx@8b966f57aeceb9616de5f15455d811ab76df9c8f/gfiles/cookies/old/style.css" rel="stylesheet" type="text/css">
</head>
<body>
    <div id="wrapper">
        <div id="topBar">
            <div><b>Cookie Clicker</b><a href="//orteil.dashnet.org" target="_blank" id="topbarOrteil">Orteil</a></div>
        </div>
        <div id="game">
            <canvas id="backgroundCanvas"></canvas>
            <div id="bigCookie"></div>
            <div id="cookieNumbers"></div>
        </div>
    </div>
</body>
</html>`;

/* GN-Math open helper */
async function openGN(){
  const mirror = state.mirrors.gn || '';
  if(state.openMode === 'tabs'){
    // open in new about:blank tab (prefer jsDelivr)
    const w = window.open('about:blank','_blank');
    try{
      const res = await fetch(mirror || 'https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/singlefile.html?t=' + Date.now());
      const html = await res.text();
      if(w){
        w.document.open(); w.document.write(html); w.document.close(); return;
      }
    }catch(e){
      if(w) w.location.href = mirror || 'https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/singlefile.html';
      return;
    }
  } else {
    // internal mode: try fetch to blob embed, fallback to new tab
    try{
      const res = await fetch(mirror || 'https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/singlefile.html?t=' + Date.now());
      if(!res.ok) throw new Error('fetch fail');
      const html = await res.text();
      createWindow({title:'GN-Math', width:980, height:640, html});
      return;
    }catch(e){
      // fallback open new tab
      window.open(mirror || 'https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/singlefile.html','_blank');
    }
  }
}

/* Itch open */
function openItch(){
  if(state.openMode === 'tabs'){ window.open('https://itch.io','_blank'); return; }
  createWindow({title:'itch.io', width:1000, height:700, url:'https://itch.io'});
}

/* Proxy open */
async function openProxy(url){
  if(!url) return;
  if(state.openMode === 'tabs'){ window.open(url,'_blank'); return; }
  // try to fetch and embed (CORS may block). If succeed, create blob. else create iframe with fallback button.
  try{
    const res = await fetch(url);
    if(res.ok){
      const txt = await res.text();
      createWindow({title:'Proxy: '+new URL(url).hostname, width:1000, height:700, html:txt});
      return;
    }
  }catch(e){}
  // fallback to iframe
  createWindow({title:'Proxy: '+url, width:1000, height:700, url});
}

/* Cookie clicker & polytrack */
function openCookie(){ if(state.openMode==='tabs'){ const w=window.open('about:blank','_blank'); try{ w.document.open(); w.document.write(cookieClickerHtml); w.document.close(); }catch(e){ w.location.href='https://orteil.dashnet.org/cookieclicker/'; } return; } createWindow({title:'Cookie Clicker', width:1000, height:720, html:cookieClickerHtml}); }
function openPoly(){ if(state.openMode==='tabs'){ const w=window.open('about:blank','_blank'); w.document.open(); w.document.write(polytrackHtml); w.document.close(); return; } createWindow({title:'PolyTrack', width:1000, height:720, html:polytrackHtml}); }

/* General launcher */
function launchApp(id){
  if(id==='gnmath') return openGN();
  if(id==='itch') return openItch();
  if(id==='proxy') return promptProxy();
  if(id==='polytrack') return openPoly();
  if(id==='cookie') return openCookie();
}

/* prompt proxy */
function promptProxy(){ const url = prompt('Enter URL to open (some sites block embedding):','https://example.com'); if(!url) return; openProxy(url); }
function openProxyFromInput(){ const u = document.getElementById('proxyInput').value.trim(); if(!u) return alert('paste a url'); openProxy(u); }

/* saves UI */
function openSavesWindow(){
  const win = createWindow({title:'Saves', width:540, height:420, left:120, top:120});
  const container = document.createElement('div'); container.style.padding='12px';
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>Saves</strong><div><button class="ghost" id="exp">Export</button> <button class="ghost" id="clr">Clear</button></div></div><div id="list" style="margin-top:10px"></div><div style="margin-top:10px"><input id="slotName" placeholder="slot"><button class="btn" id="saveDemo">Save demo</button></div>`;
  win.querySelector('.body').appendChild(container);
  const list = container.querySelector('#list');
  function refresh(){ const keys = Object.keys(state.saves); list.innerHTML = keys.length ? keys.map(k=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:var(--panel);margin-bottom:6px"><div><strong>${k}</strong><div class="muted small">${new Date(state.saves[k].ts).toLocaleString()}</div></div><div><button class="ghost" onclick="(function(s){navigator.clipboard?.writeText(JSON.stringify(state.saves[s].data));alert('copied')})('${k}')">Copy</button><button class="ghost" onclick="(function(s){ delete state.saves[s]; localStorage.setItem('void_saves', JSON.stringify(state.saves)); refresh();})(\'${k}\')">Delete</button></div></div>`).join('') : '<div class="muted small">No saves</div>'; }
  refresh();
  container.querySelector('#saveDemo').onclick = ()=>{
    const slot = container.querySelector('#slotName').value.trim() || `slot_${Date.now()}`;
    state.saves[slot] = {ts:Date.now(), data:{demo:true,score:Math.floor(Math.random()*9999)}};
    localStorage.setItem('void_saves', JSON.stringify(state.saves));
    refresh(); alert('Saved '+slot);
  };
  container.querySelector('#exp').onclick = ()=> exportAll();
  container.querySelector('#clr').onclick = ()=>{ if(confirm('Clear saves?')){ state.saves={}; localStorage.removeItem('void_saves'); refresh(); } };
}

/* settings window */
function openSettings(){
  const html = `<div style="padding:12px"><h3>Settings</h3>
    <div style="margin-top:8px"><label class="small muted">Open mode</label>
    <div style="display:flex;gap:8px;margin-top:6px"><button id="sInternal" class="ghost">Internal windows</button><button id="sTabs" class="ghost">New tabs</button></div></div>
    <div style="margin-top:12px"><label class="small muted">GN-Math mirror (optional)</label><input id="sMirror" type="text" style="width:100%;margin-top:6px" placeholder="https://..."></div>
    <div style="margin-top:10px;display:flex;gap:8px"><button id="sSave" class="btn">Save</button><button id="sClose" class="ghost">Close</button></div>
    <div style="margin-top:10px" class="muted small">If external sites refuse to embed, use "New tabs" mode or provide a static mirror that serves raw HTML.</div>
  </div>`;
  const win = createWindow({title:'Settings', width:520, height:280, left:160, top:140, html});
  setTimeout(()=>{
    const body = win.querySelector('.body');
    const sInternal = body.querySelector('#sInternal'), sTabs = body.querySelector('#sTabs');
    const sMirror = body.querySelector('#sMirror'); sMirror.value = state.mirrors.gn || '';
    function updateButtons(){ sInternal.classList.toggle('btn', state.openMode==='internal'); sTabs.classList.toggle('btn', state.openMode==='tabs'); }
    updateButtons();
    sInternal.onclick = ()=>{ state.openMode='internal'; localStorage.setItem('void_openMode',state.openMode); updateButtons(); setModeButtons(); };
    sTabs.onclick = ()=>{ state.openMode='tabs'; localStorage.setItem('void_openMode',state.openMode); updateButtons(); setModeButtons(); };
    body.querySelector('#sSave').onclick = ()=>{ state.mirrors.gn = sMirror.value.trim(); localStorage.setItem('void_mirror_gn', state.mirrors.gn); alert('Saved'); win.remove(); };
    body.querySelector('#sClose').onclick = ()=> win.remove();
  },60);
}

/* mirrors and persistence */
function saveMirrors(){ state.mirrors.gn = document.getElementById('gnMirror').value.trim(); localStorage.setItem('void_mirror_gn', state.mirrors.gn); alert('Saved'); }
function resetMirrors(){ state.mirrors={gn:''}; localStorage.removeItem('void_mirror_gn'); document.getElementById('gnMirror').value=''; alert('Reset'); }

/* Export/Import */
function exportAll(){ const payload={saves:state.saves,mirrors:state.mirrors,openMode:state.openMode}; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='void_backup.json'; a.click(); URL.revokeObjectURL(url); }
function importAll(){ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ try{ const d=JSON.parse(ev.target.result); state.saves=d.saves||{}; state.mirrors=d.mirrors||state.mirrors; state.openMode=d.openMode||state.openMode; localStorage.setItem('void_saves', JSON.stringify(state.saves)); localStorage.setItem('void_mirror_gn', state.mirrors.gn||''); localStorage.setItem('void_openMode', state.openMode||'internal'); alert('Imported'); }catch(err){alert('Invalid file')} }; r.readAsText(f); }; inp.click(); }
function clearAll(){ if(confirm('Erase launcher data?')){ localStorage.removeItem('void_saves'); localStorage.removeItem('void_mirror_gn'); localStorage.removeItem('void_openMode'); state.saves={}; state.mirrors={gn:''}; state.openMode='internal'; setModeButtons(); alert('Cleared'); } }

/* ===========================
   App launcher unified entry
   =========================== */
function launchApp(id){
  if(id==='gnmath') return openGN();
  if(id==='itch') return openItch();
  if(id==='proxy') return promptProxy();
  if(id==='polytrack') return openPoly();
  if(id==='cookie') return openCookie();
}

/* helper to call from onclick attributes (grid items) */
function launchAppByClick(id){
  launchApp(id);
}

/* wire grid click events */
document.querySelectorAll('.app').forEach((el,idx)=>{
  // map order: gnmath, itch, proxy, polytrack, cookie, saves, settings
  const mapping = ['gnmath','itch','proxy','polytrack','cookie','saves','settings'];
  el.onclick = ()=> launchApp(mapping[idx]);
});
/* but also expose named function used above */
function launchApp(id){ launchAppByClick(id); }

/* ===========================
   Utils
   =========================== */
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* expose save API for games */
window.VoidLauncher = {
  saveGame:(slot,data)=>{ state.saves[slot]={ts:Date.now(),data}; localStorage.setItem('void_saves', JSON.stringify(state.saves)); alert('Saved to '+slot); },
  loadGame:(slot)=> state.saves[slot] ? state.saves[slot].data : null,
  listSaves:()=> Object.keys(state.saves),
};

/* populate initial saves from localStorage */
try{ state.saves = JSON.parse(localStorage.getItem('void_saves')||'{}'); }catch(e){ state.saves={}; }

/* helper to open GN (exposed earlier) - ensure function visible */
async function openGN(){ return openGN_inner(); }
async function openGN_inner(){
  const mirror = state.mirrors.gn || '';
  if(state.openMode === 'tabs'){
    const w = window.open('about:blank','_blank');
    try{
      const res = await fetch(mirror || 'https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/singlefile.html?t=' + Date.now());
      const html = await res.text();
      if(w){ w.document.open(); w.document.write(html); w.document.close(); return; }
    }catch(e){
      if(w) w.location.href = mirror || 'https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/singlefile.html';
      return;
    }
  } else {
    try{
      const res = await fetch(mirror || 'https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/singlefile.html?t=' + Date.now());
      if(!res.ok) throw new Error('fetch fail');
      const html = await res.text();
      createWindow({title:'GN-Math', width:980, height:640, html});
      return;
    }catch(e){
      window.open(mirror || 'https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/singlefile.html','_blank');
    }
  }
}

/* simple wrappers for other apps */
function openItch(){ if(state.openMode==='tabs'){ window.open('https://itch.io','_blank'); return; } createWindow({title:'itch.io',width:1000,height:700,url:'https://itch.io'}); }
function openPoly(){ if(state.openMode==='tabs'){ const w=window.open('about:blank','_blank'); try{ w.document.open(); w.document.write(polytrackHtml); w.document.close(); }catch(e){ w.location.href='https://polytrack.net'; } return; } createWindow({title:'PolyTrack',width:1000,height:720,html:polytrackHtml}); }
function openCookie(){ if(state.openMode==='tabs'){ const w=window.open('about:blank','_blank'); try{ w.document.open(); w.document.write(cookieClickerHtml); w.document.close(); }catch(e){ w.location.href='https://orteil.dashnet.org/cookieclicker/'; } return; } createWindow({title:'Cookie Clicker',width:1000,height:720,html:cookieClickerHtml}); }

/* prompt proxy */
function promptProxy(){ const url = prompt('Enter URL to open (sites may block embedding):','https://example.com'); if(!url) return; openProxy(url); }

/* ===========================
   Final housekeeping
   =========================== */
/* show portal on load (simulate that school page shows first) */
document.getElementById('portal').style.display = 'flex';

/* ready */
setModeButtons();
</script>

</body>
</html>
